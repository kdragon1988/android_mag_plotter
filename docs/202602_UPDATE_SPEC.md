# MAG PLOTTER 2026年2月アップデート仕様書

**バージョン**: v2.3.0（予定）  
**作成日**: 2026-01-27  
**ステータス**: 設計中

---

## 1. 概要

### 1.1 アップデート目的

Raspberry Pi Picoの追加GPIO活用し、**視覚・聴覚フィードバック機能**を追加する。
これにより、画面を見なくても磁場ノイズの危険度を即座に把握できる「ハンズフリー計測」を実現する。

### 1.2 コンセプト

**パラグライダーのバリオメーター（高度計）方式**

- 安全時: 無音・緑LED
- 危険に近づくにつれ: ビープ音が速く・高くなり、LEDが黄→赤に変化
- 危険時: 高速連続ビープ・赤LED点滅

```
┌─────────────────────────────────────────────────────────────┐
│  ノイズ値     LED色        ビープ音                          │
│ ─────────────────────────────────────────────────────────── │
│  0-5μT       🟢 緑        無音（安全）                       │
│  5-6μT       🟡 黄緑      低音・遅いビープ（ピッ...ピッ...）  │
│  6-8μT       🟠 オレンジ   中音・中速ビープ（ピピッ...）      │
│  8-10μT      🔴 濃い赤     高音・速いビープ（ピピピピ）       │
│  10μT超      🔴 赤点滅     高音・連続ビープ（ピピピピピ！）   │
└─────────────────────────────────────────────────────────────┘
```

---

## 2. 手配部材リスト

### 2.1 必須部品

| 部品名 | 型番/仕様 | 数量 | 参考価格 | 購入先例 |
|--------|----------|------|---------|---------|
| **RGB LED (NeoPixel)** | WS2812B 5mm 砲弾型 または 5050 SMD | 1個 | ¥50〜100 | 秋月電子、Amazon |
| **パッシブブザー** | 電磁ブザー 3.3V対応 | 1個 | ¥50〜100 | 秋月電子、Amazon |
| **ジャンパーワイヤー** | オス-メス または オス-オス | 4本 | ¥100（セット） | 秋月電子 |

**合計予算**: 約¥300〜500

### 2.2 部品詳細仕様

#### RGB LED (WS2812B / NeoPixel)

| 項目 | 仕様 |
|------|------|
| 型式 | WS2812B |
| 動作電圧 | 3.5V〜5.3V（5V推奨） |
| 通信方式 | シリアル1線式（800kHz） |
| LED数 | 1個（チェーン接続で拡張可能） |
| 消費電流 | 最大60mA（フルホワイト時） |

**選定理由**:
- 1線式で制御が簡単（GPIO1本で済む）
- フルカラー制御が可能
- MicroPythonライブラリ（`neopixel`）が標準搭載

**代替品**:
- 普通のRGBカソードコモンLED + 抵抗3本（330Ω×3）でも可
- ただしGPIO3本必要

#### パッシブブザー

| 項目 | 仕様 |
|------|------|
| 種類 | パッシブ（電磁式） |
| 動作電圧 | 3.3V〜5V |
| 周波数範囲 | 100Hz〜10kHz |
| 駆動方式 | PWM |

**重要**: **アクティブブザーは不可**（固定周波数のみのため）

**選定理由**:
- PWMで任意の周波数（音程）を出力可能
- バリオメーター風の音階表現に必須

---

## 3. 配線仕様

### 3.1 既存配線（変更なし）

| F9P Pin | Pico GPIO | 機能 |
|---------|-----------|------|
| 5V | VBUS | 電源 |
| RX | GP0 | UART TX |
| TX | GP1 | UART RX |
| SCL | GP5 | I2C SCL |
| SDA | GP4 | I2C SDA |
| GND | GND | グランド |

### 3.2 追加配線

| 部品 | Pico GPIO | Pico 位置 | 備考 |
|------|-----------|-----------|------|
| **WS2812B DIN** | GP15 | 右列 20番目（最下段） | データ入力 |
| **WS2812B 5V** | VBUS | 左列 1番目 | F9Pと共有可 |
| **WS2812B GND** | GND | 左列 GND | 共通グランド |
| **ブザー +** | GP16 | 左列 21番目（最下段） | PWM出力 |
| **ブザー -** | GND | 左列 GND | 共通グランド |

### 3.3 配線図（追加分）

```
                         [USB コネクタ]
                    ┌─────────────────┐
      VBUS (5V) ◄───┤ 40            1 ├───► GP0 (TX)      ─┐
           VSYS ────┤ 39            2 ├───► GP1 (RX)       │ 既存
   F9P GND ─────►───┤ GND           3 ├──── GND            │ 配線
         3V3_EN ────┤ 37            4 ├──── GP2           ─┘
       3V3(OUT) ────┤ 36            5 ├──── GP3
       ADC_VREF ────┤ 35            6 ├───► GP4 (SDA)
          GP28  ────┤ 34            7 ├───► GP5 (SCL)
            :       │  :            : │
            :       │  :            : │
          GP22  ────┤ 29           12 ├──── GP9
  ブザー+ ──────►───┤ GP16        GP15├───► WS2812B DIN   ─┐ 追加
           GND  ────┤ GND         GND ├──── GND             │ 配線
                    └─────────────────┘                    ─┘

WS2812B (NeoPixel)            パッシブブザー
┌─────────┐                   ┌─────────┐
│  DIN ◄──┼─── GP15           │    + ◄──┼─── GP16
│  5V  ◄──┼─── VBUS           │    - ◄──┼─── GND
│  GND ◄──┼─── GND            └─────────┘
└─────────┘
```

---

## 4. ソフトウェア設計

### 4.1 設計思想

#### 非同期フィードバック
- 磁気センサーの読み取り（20Hz）とフィードバック出力を独立して処理
- ビープ音は非ブロッキングPWMで実装
- LED更新は磁気データ受信のたびに即座に反映

#### リソース効率
- ハードウェアPWMを使用し、CPU負荷を最小化
- メインループへの影響を最小限に抑える

#### 拡張性
- フィードバック設定（閾値、音程、間隔）を定数として分離
- 将来的にAndroidアプリから設定変更可能な構造

### 4.2 クラス設計

```
┌─────────────────────────────────────────────────────────────┐
│                        GpsBridge                            │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  既存コンポーネント                                   │   │
│  │  - UART (F9P通信)                                    │   │
│  │  - I2C (IST8310)                                     │   │
│  │  - USB CDC (Android通信)                             │   │
│  └─────────────────────────────────────────────────────┘   │
│                            │                                │
│                            ▼                                │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  新規コンポーネント                                   │   │
│  │  - NoiseFeedback (LED + ブザー制御)                  │   │
│  │    ├── NeoPixelController                            │   │
│  │    └── BuzzerController                              │   │
│  └─────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────┘
```

### 4.3 NoiseFeedback クラス仕様

```python
class NoiseFeedback:
    """
    ノイズ値に基づく視覚・聴覚フィードバック制御クラス
    """
    
    # 閾値設定（μT）
    THRESHOLD_SAFE = 5.0      # 安全上限
    THRESHOLD_CAUTION = 6.0   # 注意開始
    THRESHOLD_WARNING = 8.0   # 警告開始
    THRESHOLD_DANGER = 10.0   # 危険開始
    
    # ビープ設定
    BEEP_FREQ_LOW = 400       # Hz（低音）
    BEEP_FREQ_MID = 800       # Hz（中音）
    BEEP_FREQ_HIGH = 1200     # Hz（高音）
    
    BEEP_INTERVAL_SLOW = 800  # ms（遅い）
    BEEP_INTERVAL_MID = 300   # ms（中速）
    BEEP_INTERVAL_FAST = 100  # ms（速い）
    BEEP_INTERVAL_RAPID = 50  # ms（連続）
    
    # LED色設定 (R, G, B) - 0-255
    COLOR_SAFE = (0, 255, 0)       # 緑
    COLOR_CAUTION = (128, 255, 0)  # 黄緑
    COLOR_WARNING = (255, 128, 0)  # オレンジ
    COLOR_DANGER = (255, 0, 0)     # 赤
    
    def update(self, noise_value: float) -> None:
        """
        ノイズ値に応じてLEDとブザーを更新
        
        Args:
            noise_value: ノイズ値（μT）
        """
        pass
    
    def set_enabled(self, led: bool, buzzer: bool) -> None:
        """
        フィードバックの有効/無効を設定
        """
        pass
```

### 4.4 ビープ音パターン詳細

| ノイズ範囲 | 周波数 | ON時間 | OFF時間 | パターン |
|-----------|--------|--------|---------|---------|
| 0-5μT | - | - | - | 無音 |
| 5-6μT | 400Hz | 100ms | 700ms | ピッ......ピッ...... |
| 6-7μT | 600Hz | 100ms | 400ms | ピッ...ピッ... |
| 7-8μT | 800Hz | 80ms | 220ms | ピピッ..ピピッ.. |
| 8-10μT | 1000Hz | 50ms | 100ms | ピピピピピ |
| 10μT超 | 1200Hz | 30ms | 20ms | ピピピピピピピ！ |

### 4.5 LED色グラデーション

```python
def calculate_led_color(noise: float) -> tuple:
    """
    ノイズ値に応じたLED色を計算（グラデーション）
    
    0-5μT:   純緑 (0, 255, 0)
    5-7.5μT: 緑→黄→オレンジ のグラデーション
    7.5-10μT: オレンジ→赤 のグラデーション
    10μT超:  純赤点滅 (255, 0, 0)
    """
    if noise <= 5:
        return (0, 255, 0)  # 緑
    elif noise <= 7.5:
        # 緑→オレンジ (Gを減らし、Rを増やす)
        ratio = (noise - 5) / 2.5
        r = int(255 * ratio)
        g = int(255 * (1 - ratio * 0.5))
        return (r, g, 0)
    elif noise <= 10:
        # オレンジ→赤 (Gをさらに減らす)
        ratio = (noise - 7.5) / 2.5
        g = int(128 * (1 - ratio))
        return (255, g, 0)
    else:
        return (255, 0, 0)  # 赤（点滅処理は別途）
```

---

## 5. プロトコル拡張

### 5.1 フィードバック設定コマンド（Android → Pico）

Androidアプリからフィードバック設定を変更するためのコマンドを追加。

```
$PFBCFG,<led_enabled>,<buzzer_enabled>,<volume>*XX
```

| フィールド | 説明 | 値 |
|-----------|------|-----|
| led_enabled | LED有効 | 0=OFF, 1=ON |
| buzzer_enabled | ブザー有効 | 0=OFF, 1=ON |
| volume | 音量 | 0-100 |
| XX | チェックサム | 2桁HEX |

**例**: `$PFBCFG,1,1,80*5A` （LED:ON, ブザー:ON, 音量:80%）

### 5.2 フィードバック状態レポート（Pico → Android）

```
$PFBST,<noise>,<led_color>,<beep_freq>*XX
```

| フィールド | 説明 | 値 |
|-----------|------|-----|
| noise | 現在のノイズ値 | μT |
| led_color | LED色 | RRGGBB (HEX) |
| beep_freq | ビープ周波数 | Hz (0=OFF) |

**例**: `$PFBST,7.5,FF8000,800*3B`

---

## 6. Android アプリ対応

### 6.1 設定画面への追加項目

| 設定項目 | 説明 | デフォルト |
|---------|------|-----------|
| LEDフィードバック | ON/OFF | ON |
| ブザーフィードバック | ON/OFF | ON |
| ブザー音量 | 0-100% | 80% |
| ブザーモード | バリオ/シンプル | バリオ |

### 6.2 UI変更点

- 設定画面に「フィードバック設定」セクションを追加
- 計測画面のステータスバーにLED/ブザー状態アイコンを追加（任意）

---

## 7. 実装スケジュール

### Phase 1: ハードウェア準備
- [ ] 部材発注
- [ ] 配線・動作確認

### Phase 2: Picoファームウェア
- [ ] NoiseFeedbackクラス実装
- [ ] WS2812B制御実装
- [ ] PWMブザー制御実装
- [ ] 既存main.pyへの統合

### Phase 3: Android アプリ
- [ ] 設定画面UI追加
- [ ] $PFBCFGコマンド送信実装
- [ ] 設定永続化

### Phase 4: テスト・調整
- [ ] 閾値・音程の実地調整
- [ ] バッテリー消費テスト
- [ ] ユーザビリティテスト

---

## 8. 将来拡張案

### 8.1 振動モーター追加
騒音環境でも使える触覚フィードバック。

### 8.2 複数LED（LEDストリップ）
ノイズ値をバーグラフ表示。

### 8.3 設定のEEPROM保存
電源OFF後も設定を保持。

### 8.4 Bluetoothモジュール追加
ワイヤレス接続でケーブルフリー化。

---

## 9. 参考資料

### 9.1 NeoPixel MicroPythonライブラリ

```python
from neopixel import NeoPixel
from machine import Pin

# 初期化
np = NeoPixel(Pin(15), 1)  # GP15, LED 1個

# 色設定 (R, G, B)
np[0] = (255, 0, 0)  # 赤
np.write()
```

### 9.2 PWMブザー制御

```python
from machine import Pin, PWM

# 初期化
buzzer = PWM(Pin(16))

# 音を鳴らす
buzzer.freq(1000)  # 1000Hz
buzzer.duty_u16(32768)  # 50% duty

# 音を止める
buzzer.duty_u16(0)
```

---

## 10. 変更履歴

| 日付 | バージョン | 変更内容 |
|------|-----------|---------|
| 2026-01-27 | 0.1 | 初版作成 |

---

**作成者**: VISIONOID MAG PLOTTER 開発チーム
