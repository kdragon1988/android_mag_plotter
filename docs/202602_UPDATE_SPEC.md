# MAG PLOTTER 2026年2月アップデート仕様書

**バージョン**: v2.3.0 / v2.3.1  
**作成日**: 2026-01-27  
**最終更新**: 2026-01-28  
**ステータス**: ✅ リリース済み

---

## 1. 概要

### 1.1 アップデート目的

Raspberry Pi Picoの追加GPIO活用し、**視覚・聴覚フィードバック機能**を追加する。
これにより、画面を見なくても磁場ノイズの危険度を即座に把握できる「ハンズフリー計測」を実現する。

### 1.2 コンセプト

**パラグライダーのバリオメーター（高度計）方式**

- 安全時: 緑LED、無音
- 危険に近づくにつれ: ビープ音が速く・高くなり、LEDが黄→赤に変化
- 危険時: 高速連続ビープ・赤LED

```
┌─────────────────────────────────────────────────────────────┐
│  ノイズ値     LED色        ビープ音                          │
│ ─────────────────────────────────────────────────────────── │
│  0-5μT       🟢 緑        無音（安全）                       │
│  5-6μT       🟡 黄緑      低音・遅いビープ（ピッ...ピッ...）  │
│  6-8μT       🟠 オレンジ   中音・中速ビープ（ピピッ...）      │
│  8-10μT      🔴 濃い赤     高音・速いビープ（ピピピピ）       │
│  10μT超      🔴 赤        最高音・連続ビープ（ピピピピピ！）  │
└─────────────────────────────────────────────────────────────┘
```

### 1.3 起動メロディ

Pico起動時に**ファミリーマート入店音風のメロディ**を再生し、デバイスの起動完了を聴覚で確認できます。

```
♪ シ ソ レ ソ ラ レ (休) レ (休) ラ シ ラ レ ソ ♪
```

---

## 2. 手配部材リスト

### 2.1 必須部品

| 部品名 | 型番/仕様 | 数量 | 参考価格 | 購入先例 |
|--------|----------|------|---------|---------|
| **RGB LEDリング** | WS2812B 16個リング（推奨） | 1個 | ¥300〜500 | 秋月電子、Amazon |
| **パッシブブザー** | 電磁ブザー 3.3V対応 | 1個 | ¥50〜100 | 秋月電子、Amazon |
| **ジャンパーワイヤー** | オス-メス または オス-オス | 4本 | ¥100（セット） | 秋月電子 |

**合計予算**: 約¥500〜800

### 2.2 部品詳細仕様

#### RGB LED (WS2812B / NeoPixel)

| 項目 | 仕様 |
|------|------|
| 型式 | WS2812B |
| 動作電圧 | 3.5V〜5.3V（5V推奨） |
| 通信方式 | シリアル1線式（800kHz） |
| **LED数** | **16個リング推奨**（1個〜任意数に対応） |
| 消費電流 | 最大60mA×LED数（フルホワイト時） |

**選定理由**:
- 1線式で制御が簡単（GPIO1本で済む）
- フルカラー制御が可能
- MicroPythonライブラリ（`neopixel`）が標準搭載
- リング型は視認性が高い

**代替品**:
- WS2812B 単体LED（1個）でも動作可
- LEDストリップでも可

#### パッシブブザー

| 項目 | 仕様 |
|------|------|
| 種類 | パッシブ（電磁式） |
| 動作電圧 | 3.3V〜5V |
| 周波数範囲 | 100Hz〜10kHz |
| 駆動方式 | PWM |

**⚠️ 重要**: **アクティブブザーは不可**（固定周波数のみのため音階が出せない）

**選定理由**:
- PWMで任意の周波数（音程）を出力可能
- バリオメーター風の音階表現に必須

---

## 3. 配線仕様

### 3.1 既存配線（変更なし）

| F9P Pin | Pico GPIO | 機能 |
|---------|-----------|------|
| 5V | VBUS | 電源 |
| RX | GP0 | UART TX |
| TX | GP1 | UART RX |
| SCL | GP5 | I2C SCL |
| SDA | GP4 | I2C SDA |
| GND | GND | グランド |

### 3.2 追加配線

| 部品 | Pico GPIO | Pico 位置 | 備考 |
|------|-----------|-----------|------|
| **WS2812B DIN** | GP15 | 右列 20番目（最下段） | データ入力 |
| **WS2812B 5V** | VBUS | 左列 1番目 | F9Pと共有 |
| **WS2812B GND** | GND | 左列 GND | 共通グランド |
| **ブザー +** | GP16 | 左列 21番目（最下段） | PWM出力 |
| **ブザー -** | GND | 左列 GND | 共通グランド |

### 3.3 配線図

```
                         [USB コネクタ]
                    ┌─────────────────┐
      VBUS (5V) ◄───┤ 40            1 ├───► GP0 (TX)      ─┐
           VSYS ────┤ 39            2 ├───► GP1 (RX)       │ 既存
   F9P GND ─────►───┤ GND           3 ├──── GND            │ 配線
         3V3_EN ────┤ 37            4 ├──── GP2           ─┘
       3V3(OUT) ────┤ 36            5 ├──── GP3
       ADC_VREF ────┤ 35            6 ├───► GP4 (SDA)
          GP28  ────┤ 34            7 ├───► GP5 (SCL)
            :       │  :            : │
            :       │  :            : │
          GP22  ────┤ 29           12 ├──── GP9
  ブザー+ ──────►───┤ GP16        GP15├───► WS2812B DIN   ─┐ 追加
           GND  ────┤ GND         GND ├──── GND             │ 配線
                    └─────────────────┘                    ─┘

WS2812B (LEDリング)          パッシブブザー
┌─────────┐                   ┌─────────┐
│  DIN ◄──┼─── GP15           │    + ◄──┼─── GP16
│  5V  ◄──┼─── VBUS           │    - ◄──┼─── GND
│  GND ◄──┼─── GND            └─────────┘
└─────────┘
```

---

## 4. 組み込み方法・初期設定

### 4.1 ハードウェアセットアップ

#### Step 1: 部品の準備

1. **WS2812B LEDリング**（16個タイプ推奨）
2. **パッシブブザー**
3. **ジャンパーワイヤー** 4本

#### Step 2: 配線

1. LEDリングの**DIN**を**GP15**に接続
2. LEDリングの**5V**を**VBUS**に接続
3. LEDリングの**GND**を**GND**に接続
4. ブザーの**+**を**GP16**に接続
5. ブザーの**-**を**GND**に接続

### 4.2 ファームウェアインストール

#### 前提条件

- Raspberry Pi Pico (RP2040) または Pico 2 (RP2350)
- MicroPython v1.20以降がインストール済み
- Thonny IDE（推奨）

#### Step 1: MicroPythonのインストール（初回のみ）

1. Picoの**BOOTSEL**ボタンを押しながらUSB接続
2. 表示されるドライブに MicroPython の `.uf2` ファイルをコピー
3. 自動的に再起動

#### Step 2: main.pyの書き込み

1. **Thonny IDE**を起動
2. PicoをUSB接続
3. 右下のインタプリタで「MicroPython (Raspberry Pi Pico)」を選択
4. `pico/main.py` を開く
5. **ファイル → 名前を付けて保存 → Raspberry Pi Pico → main.py**

#### Step 3: 動作確認

1. USBケーブルを抜いて再接続
2. **起動メロディ（ファミマ音）が鳴ればOK**
3. LEDリングが緑→シアン→青と変化しながら点灯

### 4.3 LED数のカスタマイズ

`main.py` の定数を変更することで、異なるLED数に対応可能：

```python
# 16個リング（デフォルト）
NEOPIXEL_COUNT = 16

# 単体LED
NEOPIXEL_COUNT = 1

# 8個リング
NEOPIXEL_COUNT = 8
```

### 4.4 基準磁場値の調整

日本以外の地域で使用する場合、基準磁場値を調整：

```python
# デフォルト（日本平均）
REFERENCE_MAG = 46.0

# 例：赤道付近
REFERENCE_MAG = 35.0

# 例：北欧
REFERENCE_MAG = 55.0
```

### 4.5 トラブルシューティング

| 症状 | 原因 | 対処法 |
|------|------|--------|
| 起動音が鳴らない | ブザーがアクティブ型 | パッシブブザーに交換 |
| LEDが点灯しない | 配線ミス / 電力不足 | 配線確認、VBUSから給電 |
| 音が小さい | PWMデューティ比 | `buzzer.duty_u16(32768)` を確認 |
| Thonnyで接続できない | kbd_intr(-1) が有効 | BOOTSELモードでリセット |
| エラー時に赤点滅 | 初期化エラー | シリアルモニタでエラー確認 |

---

## 5. ソフトウェア設計

### 5.1 設計思想

#### 非同期フィードバック
- 磁気センサーの読み取り（20Hz）とフィードバック出力を独立して処理
- ビープ音は非ブロッキングPWMで実装
- LED更新は磁気データ受信のたびに即座に反映

#### リソース効率
- ハードウェアPWMを使用し、CPU負荷を最小化
- メインループへの影響を最小限に抑える

#### 輝度制限
- 消費電流を抑えるため、デフォルト輝度を25%に制限
- `NEOPIXEL_BRIGHTNESS = 0.25`

### 5.2 クラス構成

```
┌─────────────────────────────────────────────────────────────┐
│                        GpsBridge                            │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  既存コンポーネント                                   │   │
│  │  - UART (F9P通信)                                    │   │
│  │  - I2C (IST8310)                                     │   │
│  │  - USB CDC (Android通信)                             │   │
│  └─────────────────────────────────────────────────────┘   │
│                            │                                │
│                            ▼                                │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  NoiseFeedback                                       │   │
│  │  - NeoPixel制御（全LEDを同色 or バーグラフ）         │   │
│  │  - PWMブザー制御（非同期ビープ）                     │   │
│  │  - playStartupSequence()（起動メロディ）            │   │
│  └─────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────┘
```

### 5.3 NoiseFeedback クラス仕様

```python
class NoiseFeedback:
    """
    ノイズ値に基づく視覚・聴覚フィードバック制御クラス
    """
    
    # 閾値設定（μT）
    NOISE_THRESHOLD_SAFE = 5.0      # 安全上限
    NOISE_THRESHOLD_CAUTION = 6.0   # 注意開始
    NOISE_THRESHOLD_WARNING = 8.0   # 警告開始
    NOISE_THRESHOLD_DANGER = 10.0   # 危険開始
    
    def __init__(self):
        """起動時にメロディー再生"""
        self.playStartupSequence()
    
    def playStartupSequence(self):
        """ファミマ入店音風メロディー + LEDアニメーション"""
        pass
    
    def update(self, noise: float) -> None:
        """ノイズ値に応じてLEDとブザーパラメータを更新"""
        pass
    
    def processBeep(self) -> None:
        """非同期ビープ処理（メインループから毎回呼び出し）"""
        pass
    
    def off(self) -> None:
        """全フィードバックを停止"""
        pass
```

### 5.4 ビープ音パターン詳細

| ノイズ範囲 | 周波数 | ON時間 | OFF時間 | パターン |
|-----------|--------|--------|---------|---------|
| 0-5μT | - | - | - | 無音 |
| 5-6μT | 400Hz | 50ms | 650ms | ピッ......ピッ...... |
| 6-7μT | 600Hz | 50ms | 450ms | ピッ...ピッ... |
| 7-8μT | 800Hz | 50ms | 250ms | ピピッ..ピピッ.. |
| 8-9μT | 1000Hz | 50ms | 100ms | ピピピピピ |
| 9-10μT | 1100Hz | 50ms | 50ms | ピピピピピピ |
| 10μT超 | 1200Hz | 50ms | 0ms | ピピピピピピピ！ |

### 5.5 LED色グラデーション

```python
def calculateColor(self, noise):
    """ノイズ値に応じたLED色を計算"""
    if noise <= 5.0:
        return (0, 255, 0)  # 緑
    elif noise <= 6.0:
        # 緑→黄緑
        ratio = (noise - 5.0) / 1.0
        return (int(128 * ratio), 255, 0)
    elif noise <= 8.0:
        # 黄緑→オレンジ
        ratio = (noise - 6.0) / 2.0
        return (int(128 + 127 * ratio), int(255 * (1 - ratio * 0.5)), 0)
    elif noise <= 10.0:
        # オレンジ→赤
        ratio = (noise - 8.0) / 2.0
        return (255, int(128 * (1 - ratio)), 0)
    else:
        return (255, 0, 0)  # 赤
```

---

## 6. 起動メロディ仕様

### 6.1 ファミマ入店音

```python
# 周波数定義 (オクターブ4-5)
B4 = 494   # シ
G4 = 392   # ソ
D4 = 294   # レ (低)
A4 = 440   # ラ
D5 = 587   # レ (高)

# メロディ構成
melody = [
    # 前半: シ ソ レ ソ ラ レ
    (B4, 150), (G4, 150), (D4, 150), (G4, 150), (A4, 150), (D5, 150),
    # 休符
    (REST, 100),
    # レ
    (D5, 150),
    # 休符
    (REST, 100),
    # 後半: ラ シ ラ レ ソ
    (A4, 200), (B4, 200), (A4, 200), (D4, 200), (G4, 400),
]
```

### 6.2 LEDアニメーション

メロディ再生中、LEDが順次点灯（緑→シアン系のファミマカラー）

```python
colors = [
    (0, 255, 100),    # 緑っぽい
    (0, 200, 255),    # シアン
    (100, 255, 100),  # 明るい緑
    (0, 150, 255),    # 青っぽい
]
```

---

## 7. Android アプリ対応（v2.3.1）

### 7.1 ヒートマップ改善

| 改善項目 | 内容 |
|---------|------|
| USB磁気センサー値 | 記録時にIST8310の値を正しく使用 |
| 閾値統一 | ゲージ・ヒートマップ・統計で5/10μT固定 |
| パフォーマンス | 差分更新方式で高速化 |
| Z順序制御 | 危険値（赤）を常に前面に表示 |

### 7.2 UI改善

| 項目 | 変更内容 |
|------|---------|
| 現在位置アイコン | 指アイコン → 青い丸印（中心が正確な位置） |

---

## 8. プロトコル拡張（将来予定）

### 8.1 フィードバック設定コマンド（Android → Pico）

```
$PFBCFG,<led_enabled>,<buzzer_enabled>,<volume>*XX
```

| フィールド | 説明 | 値 |
|-----------|------|-----|
| led_enabled | LED有効 | 0=OFF, 1=ON |
| buzzer_enabled | ブザー有効 | 0=OFF, 1=ON |
| volume | 音量 | 0-100 |

### 8.2 フィードバック状態レポート（Pico → Android）

```
$PFBST,<noise>,<led_color>,<beep_freq>*XX
```

---

## 9. 将来拡張案

### 9.1 振動モーター追加
騒音環境でも使える触覚フィードバック。

### 9.2 バーグラフ表示モード
LEDリングをノイズ値のレベルメーターとして使用。

### 9.3 設定のFlash保存
電源OFF後も設定を保持。

### 9.4 Android設定画面
- LEDフィードバック ON/OFF
- ブザーフィードバック ON/OFF
- ブザー音量 0-100%
- ブザーモード（バリオ/シンプル）

---

## 10. 参考資料

### 10.1 NeoPixel MicroPythonライブラリ

```python
from neopixel import NeoPixel
from machine import Pin

# 初期化（16個リング）
np = NeoPixel(Pin(15), 16)

# 色設定 (R, G, B)
for i in range(16):
    np[i] = (255, 0, 0)  # 赤
np.write()
```

### 10.2 PWMブザー制御

```python
from machine import Pin, PWM

# 初期化
buzzer = PWM(Pin(16))

# 音を鳴らす
buzzer.freq(1000)  # 1000Hz
buzzer.duty_u16(32768)  # 50% duty

# 音を止める
buzzer.duty_u16(0)
```

---

## 11. 変更履歴

| 日付 | バージョン | 変更内容 |
|------|-----------|---------|
| 2026-01-27 | 0.1 | 初版作成（設計中） |
| 2026-01-28 | 1.0 | 実装完了・確定版にアップデート |
| | | - ステータスを「リリース済み」に変更 |
| | | - LEDリング16個対応を追記 |
| | | - 起動メロディ（ファミマ音）を追記 |
| | | - 組み込み方法・初期設定セクションを追加 |
| | | - トラブルシューティングを追加 |
| | | - v2.3.1 Android改善内容を追記 |

---

**作成者**: VISIONOID MAG PLOTTER 開発チーム
